<div class="group-management">
  <div class="header d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">群组管理</h2>
    <button class="btn btn-primary" (click)="openCreateModal()" *ngIf="authService.hasRole(['admin', 'quoter'])">
      <i class="bi bi-plus-circle me-2"></i> 创建群组
    </button>
  </div>

  <!-- 加载状态 -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
    <p class="mt-2">加载中...</p>
  </div>

  <!-- 错误信息 -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
  </div>

  <!-- 群组列表 -->
  <div *ngIf="!loading" class="groups-container">
    <div class="group-card" *ngFor="let group of groups">
      <div class="group-header">
        <div class="group-info">
          <h3>{{ group.name }}</h3>
          <span class="status-badge" [class]="group.isActive ? 'active' : 'inactive'">
            {{ group.isActive ? '启用' : '禁用' }}
          </span>
        </div>
        <div class="group-actions" *ngIf="authService.hasRole(['admin', 'quoter'])">
          <button class="btn btn-sm btn-outline-primary" (click)="openEditModal(group)" title="编辑群组">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-info" (click)="openAssignModal(group)" title="分配成员">
            <i class="bi bi-people"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="deleteGroup(group)" title="删除群组">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="group-body">
        <p *ngIf="group.description" class="description">{{ group.description }}</p>
        
        <div class="group-meta">
          <small><i class="bi bi-person"></i> 创建者: {{ group.createdBy.name }}</small>
          <small><i class="bi bi-calendar"></i> {{ group.createdAt | date:'yyyy-MM-dd HH:mm' }}</small>
        </div>

        <div class="users-section" *ngIf="group.users && group.users.length > 0">
          <h4><i class="bi bi-people"></i> 群组成员 ({{ group.users.length }})</h4>
          <div class="users-grid">
            <div class="user-item" *ngFor="let user of group.users">
              <i class="bi bi-person-circle"></i>
              <div class="user-info">
                <span class="user-name">{{ user.name }}</span>
                <span class="user-email">{{ user.email }}</span>
                <span *ngIf="user.company" class="user-company">{{ user.company }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 空状态 -->
  <div *ngIf="!loading && groups.length === 0" class="text-center py-5">
    <i class="bi bi-people fs-1 text-muted"></i>
    <h3 class="mt-3">暂无群组</h3>
    <p *ngIf="authService.hasRole(['admin', 'quoter'])" class="text-muted">
      点击上方按钮创建第一个群组
    </p>
  </div>
</div>

<!-- 创建群组模态框 -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" 
     [class.d-block]="showCreateModal" tabindex="-1" (click)="closeCreateModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle-fill text-success me-2"></i>创建新群组
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createGroup()">
          <div class="mb-3">
            <label for="groupName" class="form-label">
              群组名称 <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="groupName" 
                   [(ngModel)]="groupForm.name" name="name" required 
                   placeholder="请输入群组名称，例如：电子元件供应商">
          </div>
          
          <div class="mb-3">
            <label for="groupDescription" class="form-label">群组描述</label>
            <textarea class="form-control" id="groupDescription" rows="3"
                      [(ngModel)]="groupForm.description" name="description"
                      placeholder="请输入群组描述（可选）"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
              <i class="bi bi-x-circle me-2"></i>取消
            </button>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-plus-circle me-2"></i>创建群组
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 编辑群组模态框 -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" 
     [class.d-block]="showEditModal" tabindex="-1" (click)="closeEditModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square text-primary me-2"></i>编辑群组
        </h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <div class="d-flex justify-content-between">
            <span class="fw-bold">当前群组:</span>
            <span>{{ editForm.name }}</span>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <span class="fw-bold">创建时间:</span>
            <span>{{ selectedGroup?.createdAt | date:'yyyy-MM-dd' }}</span>
          </div>
        </div>
        
        <form (ngSubmit)="updateGroup()">
          <div class="mb-3">
            <label for="editGroupName" class="form-label">
              群组名称 <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="editGroupName" 
                   [(ngModel)]="editForm.name" name="name" required 
                   placeholder="请输入群组名称">
          </div>
          
          <div class="mb-3">
            <label for="editGroupDescription" class="form-label">群组描述</label>
            <textarea class="form-control" id="editGroupDescription" rows="3"
                      [(ngModel)]="editForm.description" name="description"
                      placeholder="请输入群组描述（可选）"></textarea>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="editGroupActive"
                     [(ngModel)]="editForm.isActive" name="isActive">
              <label class="form-check-label" for="editGroupActive">
                <i class="bi bi-power me-2"></i>启用群组
                <div class="form-text">禁用后，该群组将无法被分配新的询价单</div>
              </label>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
              <i class="bi bi-x-circle me-2"></i>取消
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle me-2"></i>保存修改
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 分配用户模态框 -->
<div class="modal fade" [class.show]="showAssignModal" [style.display]="showAssignModal ? 'block' : 'none'" 
     [class.d-block]="showAssignModal" tabindex="-1" (click)="closeAssignModal()">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-people-fill text-info me-2"></i>分配供应商到群组
        </h5>
        <button type="button" class="btn-close" (click)="closeAssignModal()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-tag-fill me-2"></i>
            <strong>{{ selectedGroup?.name }}</strong>
          </div>
          <div>
            <i class="bi bi-check-circle-fill text-success me-1"></i>
            已选择 <strong>{{ selectedSuppliers.length }}</strong> 个供应商
          </div>
        </div>
        
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="搜索供应商姓名、邮箱或公司..."
                   (input)="filterSuppliers($event)">
          </div>
        </div>
        
        <div style="max-height: 300px; overflow-y: auto;">
          <div *ngIf="filteredSuppliers.length === 0" class="text-center py-4 text-muted">
            <i class="bi bi-search fs-1"></i>
            <p class="mt-2">未找到匹配的供应商</p>
          </div>
          
          <div class="list-group" *ngIf="filteredSuppliers.length > 0">
            <div class="list-group-item" *ngFor="let supplier of filteredSuppliers">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       [value]="supplier._id"
                       [checked]="selectedSuppliers.includes(supplier._id)"
                       (change)="onSupplierSelectionChange($event)"
                       [id]="'supplier-' + supplier._id">
                <label class="form-check-label d-flex align-items-center w-100" 
                       [for]="'supplier-' + supplier._id">
                  <i class="bi bi-person-circle fs-4 me-3 text-muted"></i>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                      <strong>{{ supplier.name }}</strong>
                      <span class="badge bg-success">活跃</span>
                    </div>
                    <div class="small text-muted">{{ supplier.email }}</div>
                    <div *ngIf="supplier.company" class="small text-muted">
                      <i class="bi bi-building me-1"></i>{{ supplier.company }}
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeAssignModal()">
            <i class="bi bi-x-circle me-2"></i>取消
          </button>
          <button type="button" class="btn btn-info" (click)="assignUsersToGroup()">
            <i class="bi bi-people-plus me-2"></i>确认更新成员
            <span *ngIf="selectedSuppliers.length > 0">({{ selectedSuppliers.length }})</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 模态框背景遮罩 -->
<div class="modal-backdrop fade" [class.show]="showCreateModal || showEditModal || showAssignModal" 
     [style.display]="(showCreateModal || showEditModal || showAssignModal) ? 'block' : 'none'"></div>