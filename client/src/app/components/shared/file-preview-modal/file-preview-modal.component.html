<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filePreviewModalLabel">
          <i class="bi bi-eye me-2"></i>文件预览: {{ currentPreviewFile?.originalName }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-preview-container" *ngIf="currentPreviewFile">
          <!-- 加载中状态 -->
          <div *ngIf="previewLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-3 text-muted">正在加载文件预览...</p>
          </div>
          
          <!-- 错误状态 -->
          <div *ngIf="previewError" class="text-center py-5">
            <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
            <h5 class="mt-3">预览失败</h5>
            <p class="text-muted">{{ previewError }}</p>
            <button type="button" class="btn btn-outline-primary" (click)="onDownloadFile()">
              <i class="bi bi-download me-1"></i>下载文件
            </button>
          </div>
          
          <!-- 图片预览 -->
          <div *ngIf="!previewLoading && !previewError && isImageFile(currentPreviewFile.originalName)" class="text-center">
            <img [src]="getSafeImageUrl()" 
                 [alt]="currentPreviewFile.originalName" 
                 class="img-fluid rounded shadow-sm"
                 style="max-height: 70vh;">
          </div>
          
          <!-- PDF预览 -->
          <div *ngIf="!previewLoading && !previewError && isPdfFile(currentPreviewFile.originalName)" class="embed-responsive embed-responsive-16by9">
            <iframe [src]="getSafePdfUrl()" 
                    class="embed-responsive-item rounded shadow-sm"
                    style="width: 100%; height: 70vh; border: none;"
                    title="{{ currentPreviewFile.originalName }}">
            </iframe>
          </div>
          
          <!-- Office文件 - 不支持预览，直接显示下载 -->
          <div *ngIf="!previewLoading && !previewError && isOfficeFile(currentPreviewFile.originalName)" class="text-center py-5">
            <i class="bi bi-file-earmark-excel fs-1 text-success" *ngIf="getFileExtension(currentPreviewFile.originalName) === '.xlsx' || getFileExtension(currentPreviewFile.originalName) === '.xls'"></i>
            <i class="bi bi-file-earmark-word fs-1 text-primary" *ngIf="getFileExtension(currentPreviewFile.originalName) === '.docx' || getFileExtension(currentPreviewFile.originalName) === '.doc'"></i>
            <i class="bi bi-file-earmark-ppt fs-1 text-warning" *ngIf="getFileExtension(currentPreviewFile.originalName) === '.pptx' || getFileExtension(currentPreviewFile.originalName) === '.ppt'"></i>
            <h5 class="mt-3">{{ getFileTypeDisplayName(currentPreviewFile.originalName) }} 文件</h5>
            <p class="text-muted">请下载文件后使用 Microsoft Office 或兼容软件查看</p>
            <button type="button" class="btn btn-primary btn-lg" (click)="onDownloadFile()">
              <i class="bi bi-download me-2"></i>下载 {{ getFileTypeDisplayName(currentPreviewFile.originalName) }} 文件
            </button>
          </div>
          
          <!-- 不支持预览的文件 -->
          <div *ngIf="!previewLoading && !previewError && !isImageFile(currentPreviewFile.originalName) && !isPdfFile(currentPreviewFile.originalName) && !isOfficeFile(currentPreviewFile.originalName)" class="text-center py-5">
            <i class="bi bi-file-earmark fs-1 text-muted"></i>
            <h5 class="mt-3">此文件类型不支持预览</h5>
            <p class="text-muted">请下载文件后查看</p>
            <button type="button" class="btn btn-outline-primary" (click)="onDownloadFile()">
              <i class="bi bi-download me-1"></i>下载文件
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" (click)="onDownloadFile()">
          <i class="bi bi-download me-1"></i>下载文件
        </button>
      </div>
    </div>
  </div>
</div>