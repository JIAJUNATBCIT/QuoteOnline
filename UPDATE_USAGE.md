# 更新脚本使用说明

## update.sh 脚本

用于更新代码并重启Docker容器的自动化脚本。

## 用法

```bash
# 普通更新（有未提交更改时会尝试暂存）
sudo ./update.sh

# 强制更新（强制覆盖本地未提交的更改）
sudo ./update.sh --force

# 显示帮助信息
sudo ./update.sh --help
```

## 选项说明

- `--force` 或 `-f`：强制覆盖模式，会丢弃所有本地未提交的更改
- `--help` 或 `-h`：显示帮助信息

## 功能说明

### 普通模式（默认）
- 检测未提交的更改时会尝试使用 `git stash` 暂存
- 然后执行 `git pull` 拉取最新代码
- 如果暂存失败，会继续执行但保留警告信息

### 强制模式（--force）
- 检测到未提交的更改时会：
  - `git reset --hard HEAD`：重置到最后一次提交
  - `git clean -fd`：删除未跟踪的文件
  - `git fetch origin`：获取远程更新
  - `git reset --hard origin/main`：强制与远程同步

## 安全提示

- **强制模式会永久删除本地所有未提交的更改**，请确保这些更改不再需要
- 建议在强制更新前备份重要文件
- 脚本需要 root 权限运行

## 示例场景

### 场景1：正常的开发更新
```bash
# 本地有未提交的更改，想要保留
sudo ./update.sh
# 脚本会尝试暂存更改，然后拉取最新代码
```

### 场景2：紧急部署，需要覆盖本地更改
```bash
# 本地有临时测试代码，想要完全被远程覆盖
sudo ./update.sh --force
# 脚本会丢弃所有本地更改，强制同步远程代码
```

## 错误处理

脚本会在以下情况报错退出：
1. 非 root 用户运行
2. 项目目录不存在
3. 当前目录不是 Git 仓库
4. Git 操作失败（拉取/重置）
5. Docker 操作失败（构建/启动）

## 输出示例

```
========================================
      代码更新和容器重启
      强制覆盖模式
========================================
[14:30:15] ✓ 权限检查通过
[14:30:15] ✓ 项目目录检查通过
[14:30:16] ⚠ 检测到未提交的更改，将强制覆盖...
[14:30:16] ✓ 本地更改已清理
[14:30:18] ✓ 代码更新完成（强制覆盖模式）
[14:30:18] ✓ 容器启动成功
[14:30:33] ✓ 服务健康检查通过
[14:30:33] ✓ 部署信息:
----------------------------------------
项目目录: /var/www/QuoteOnline
更新时间: Tue Dec 24 14:30:33 UTC 2025
Git提交: abc1234
----------------------------------------
[14:30:33] ✓ 🎉 更新完成！
```