# 报价员上传文件性能优化方案

## 问题分析

报价员上传报价文件响应慢的主要原因：

1. **缺少上传进度监控** - 用户无法看到上传进度
2. **邮件发送阻塞** - 虽然异步但仍可能影响响应时间
3. **数据库查询未优化** - 缺少合适的索引
4. **文件上传处理效率低** - multer配置不够优化
5. **缺少性能监控** - 无法识别性能瓶颈

## 优化方案

### 1. 前端优化

#### 1.1 实现真正的上传进度监控
- 使用 XMLHttpRequest 替代 HttpClient
- 添加上传进度事件监听
- 实现超时处理和错误重试机制

#### 1.2 改进用户体验
- 显示实时上传进度百分比
- 上传期间禁用其他操作
- 提供明确的错误提示

### 2. 后端优化

#### 2.1 数据库连接优化
```javascript
// 连接池配置
maxPoolSize: 10,
serverSelectionTimeoutMS: 5000,
socketTimeoutMS: 45000,
bufferMaxEntries: 0,
bufferCommands: false
```

#### 2.2 索引优化
- 添加复合索引：`{ customer: 1, status: 1 }`
- 添加复合索引：`{ quoter: 1, status: 1 }`
- 添加复合索引：`{ status: 1, createdAt: -1 }`
- 优化单字段索引

#### 2.3 文件上传优化
- 使用唯一文件名避免冲突
- 增加文件大小限制
- 优化文件类型检查
- 增加上传超时时间到60秒

#### 2.4 查询性能优化
- 使用 lean() 查询减少内存开销
- 优化 populate 操作
- 添加详细的性能日志

### 3. 性能监控

#### 3.1 请求监控
- 记录每个请求的执行时间
- 识别慢请求（>5秒）
- 详细的错误日志记录

#### 3.2 数据库监控
- 记录数据库操作耗时
- 监控查询性能
- 识别性能瓶颈

## 预期效果

### 上传性能提升
- **响应时间**: 从可能10-30秒降低到3-5秒
- **用户体验**: 实时进度显示，明确的操作反馈
- **稳定性**: 更好的错误处理和超时机制

### 系统性能提升
- **数据库查询**: 通过索引优化，查询速度提升50-80%
- **并发处理**: 连接池优化，支持更多并发用户
- **监控能力**: 完整的性能监控体系

## 使用方法

### 1. 重启服务器
```bash
npm start
```

### 2. 性能测试
```bash
node scripts/performance-test.js
```

### 3. 监控日志
查看 `logs/` 目录下的日志文件，关注：
- 请求执行时间
- 数据库操作耗时
- 慢请求警告

## 进一步优化建议

### 1. 文件存储优化
- 考虑使用云存储服务（如阿里云OSS）
- 实现文件压缩
- 添加CDN加速

### 2. 缓存策略
- 添加Redis缓存热点数据
- 实现查询结果缓存
- 优化静态资源缓存

### 3. 负载均衡
- 多实例部署
- 数据库读写分离
- API网关优化

## 监控指标

### 关键性能指标（KPI）
- **上传响应时间**: < 5秒
- **数据库查询时间**: < 100ms
- **并发用户数**: 支持50+
- **系统可用性**: > 99.9%

### 监控工具
- 自定义日志系统
- 性能测试脚本
- 错误追踪机制

## 故障排查

### 常见问题
1. **上传超时**: 检查文件大小和网络连接
2. **数据库慢**: 检查索引和查询语句
3. **内存占用高**: 检查连接池配置和查询优化

### 日志分析
- 查看 `logs/` 目录下的日志文件
- 关注 ERROR 和 WARN 级别的日志
- 分析慢请求日志

---

**注意**: 这些优化需要重启服务器才能生效。建议在测试环境先验证效果，然后部署到生产环境。