# 客户隐私保护文档

## 概述

系统实施了严格的客户隐私保护措施，确保报价员无法访问客户的任何个人信息，包括姓名、邮箱、公司等。

## 隐私保护措施

### 🛡️ 后端API保护

#### 1. 获取询价单列表 (`GET /api/quotes`)
- **客户**: 只能看到自己的询价单
- **报价员**: 可以看到所有询价单，但客户信息被完全移除
- **管理员**: 可以看到所有询价单的完整信息

#### 2. 获取询价单详情 (`GET /api/quotes/:id`)
- **客户**: 只能查看自己的询价单详情
- **报价员**: 可以查看询价单详情，但客户信息被完全移除
- **管理员**: 可以查看询价单的完整详情

#### 3. 更新询价单 (`PUT /api/quotes/:id`)
- **报价员**: 更新成功后，响应中不包含客户信息

#### 4. 拒绝报价 (`PATCH /api/quotes/:id/reject`)
- **报价员**: 拒绝成功后，响应中不包含客户信息

### 📧 邮件隐私保护

#### 发送给报价员的询价通知邮件
**移除的信息:**
- ❌ 客户姓名
- ❌ 客户邮箱  
- ❌ 客户公司

**保留的信息:**
- ✅ 询价号
- ✅ 询价标题
- ✅ 询价描述
- ✅ 客户留言（不包含个人身份信息）
- ✅ 创建时间
- ✅ 附件文件

### 🎨 前端界面保护

#### 询价单列表页面
- **报价员**: 不显示"客户"列
- **客户/管理员**: 显示客户信息

#### 询价单详情页面  
- **报价员**: 不显示客户信息区域
- **客户/管理员**: 显示完整的客户信息

#### 仪表板页面
- **报价员**: 不显示"客户"列
- **客户/管理员**: 显示客户信息

## 技术实现

### 后端实现示例

```javascript
// 报价员视角 - 移除客户信息
if (req.user.role === 'quoter') {
  const quoteObj = quote.toObject();
  delete quoteObj.customer;
  return res.json(quoteObj);
}
```

### 前端实现示例

```html
<!-- 只对客户和管理员显示客户信息 -->
<div *ngIf="authService.hasRole('customer') || authService.hasRole('admin')">
  <label class="form-label fw-bold">客户:</label>
  <div class="form-control-plaintext">{{ quote.customer.name }}</div>
</div>
```

### 邮件模板实现

发送给报价员的邮件模板中完全移除了客户信息字段，只保留询价相关的业务信息。

## 安全验证

### 数据库层面
- 客户信息仍然安全存储在数据库中
- 只有授权的用户才能访问
- 报价员的API请求会自动过滤客户信息

### API层面
- 所有API响应都经过角色验证
- 报价员无法通过任何API端点获取客户信息
- 管理员保留完整的访问权限

### 前端层面
- 基于用户角色动态显示/隐藏信息
- 即使前端被绕过，后端仍会保护数据

## 日志记录

所有涉及客户信息的操作都会被记录到日志文件中：
- 访问尝试
- 数据修改
- 权限验证失败

## 合规性

这些隐私保护措施符合：
- **数据最小化原则**: 只收集和显示必要的业务信息
- **角色基础访问控制**: 根据用户角色限制数据访问
- **隐私设计**: 在系统设计阶段就考虑了隐私保护

## 测试验证

系统包含隐私保护测试，验证：
- ✅ 报价员无法看到客户信息
- ✅ 管理员可以看到完整信息  
- ✅ 客户只能看到自己的信息
- ✅ 邮件中不包含客户隐私信息

## 注意事项

1. **管理员权限**: 管理员拥有完整的访问权限，应谨慎分配
2. **日志安全**: 日志文件可能包含敏感信息，需要妥善保管
3. **前端安全**: 不要仅依赖前端隐藏信息，后端保护是关键
4. **定期审计**: 建议定期检查隐私保护措施的有效性

## 更新记录

- **2025-11-18**: 实施完整的客户隐私保护系统
  - 移除报价员邮件中的客户信息
  - 前端界面根据角色隐藏客户信息
  - 后端API响应过滤客户数据
  - 添加隐私保护测试