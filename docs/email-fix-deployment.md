# 邮件超时问题修复部署指南

## 问题描述
客户创建询价单后前端白屏，需要手动刷新才能看到询价单列表。错误日志显示：
```
Connection timeout
邮件发送失败
报价员分配通知邮件发送失败: Connection timeout
```

## 修复内容

### 1. ✅ 邮件服务配置优化
- **连接超时**: 30秒 → 60秒
- **握手超时**: 10秒 → 15秒  
- **Socket超时**: 60秒 → 120秒
- **启用连接池**: pool: true, maxConnections: 5
- **添加速率限制**: 每秒最多5封邮件

### 2. ✅ 询价单创建逻辑优化
- **异步发送**: setImmediate → setTimeout (延迟1秒)
- **串行发送**: 避免并行发送导致连接池耗尽
- **超时保护**: 单个邮件45秒超时
- **发送间隔**: 每封邮件间隔1秒
- **查询超时**: 数据库查询10秒超时保护

### 3. ✅ 邮件降级策略
- **失败计数**: 连续3次失败触发降级
- **冷却机制**: 降级后5分钟内跳过邮件发送
- **自动恢复**: 冷却期结束自动尝试恢复
- **详细日志**: 记录降级状态和恢复过程

## 服务器部署步骤

### 1. SSH连接服务器
```bash
ssh user@portal.ooishipping.com
cd /var/www/QuoteOnline
```

### 2. 拉取最新代码
```bash
git pull origin main
```

### 3. 重启后端服务
```bash
pm2 restart quoteonline
```

### 4. 验证服务状态
```bash
pm2 status
pm2 logs quoteonline --lines 20
```

## 预期效果

### ✅ 解决的问题
1. **白屏问题**: 创建询价单不再因邮件超时而白屏
2. **响应速度**: 询价单创建响应时间大幅缩短
3. **稳定性**: 邮件服务不稳定时不影响核心功能
4. **用户体验**: 用户创建询价单后立即显示在列表中

### ⚡ 性能改进
- **创建时间**: 从可能30+秒降低到1-2秒
- **邮件发送**: 异进行，不阻塞用户操作
- **容错能力**: 邮件失败时系统继续正常工作

## 测试验证

### 1. 功能测试
1. 登录系统
2. 创建新的询价单
3. 确认立即跳转到询价单列表
4. 验证新询价单显示在列表中

### 2. 邮件测试
```bash
# 查看邮件发送日志
tail -f logs/quoteonline.log | grep "邮件"

# 查询邮件发送状态
grep "询价单.*报价员分配通知邮件发送完成" logs/quoteonline.log
```

### 3. 错误处理测试
- 故意配置错误的邮件服务器
- 验证询价单创建仍能正常工作
- 检查邮件降级策略是否生效

## 监控建议

### 1. 关键指标
- 询价单创建响应时间
- 邮件发送成功率
- 邮件降级触发次数

### 2. 日志监控
```bash
# 监控邮件发送状态
grep -E "(邮件发送|Connection timeout)" logs/quoteonline.log

# 监控邮件降级
grep "邮件服务已降级" logs/quoteonline.log
```

## 注意事项
- 修复后需要重启后端服务
- 新增了emailFallbackService.js文件
- 邮件配置已优化，增加超时和连接池设置
- 询价单创建不再等待邮件发送完成