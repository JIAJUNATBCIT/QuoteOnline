name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      server_ip:
        required: true
        type: string
      github_pat:  # æ¥æ”¶ä» deploy.sh ä¼ é€’çš„ PAT
        required: true
        type: string
      domain:  # æ¥æ”¶ä» deploy.sh ä¼ é€’çš„åŸŸå
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout ä»£ç ï¼ˆå¯é€‰ï¼Œå¦‚éœ€ä½¿ç”¨ä»“åº“å†…çš„è„šæœ¬ï¼‰
        uses: actions/checkout@v4

      - name: ç”Ÿæˆ .env æ–‡ä»¶ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯å’ŒåŸŸåï¼‰
        run: |
          cat > .env <<EOF
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://${{ github.event.inputs.domain }}  # ä½¿ç”¨ä¼ é€’çš„åŸŸå
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
          EOF

      - name: ä¸Šä¼ æ–‡ä»¶å¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨
        env:
          SERVER_IP: ${{ github.event.inputs.server_ip }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}  # æœåŠ¡å™¨å¯†ç ä» GitHub Secrets è·å–
          GITHUB_PAT: ${{ github.event.inputs.github_pat }}
          GITHUB_USERNAME: "JIAJUNATBCIT"
          GITHUB_REPO: "QuoteOnline"
          DOMAIN: ${{ github.event.inputs.domain }}
        run: |
          # ä¸Šä¼  .envã€docker-compose.yml åˆ°æœåŠ¡å™¨
          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env docker-compose.yml \
            root@$SERVER_IP:/var/www/QuoteOnline/

          # é€šè¿‡ SSH æ‰§è¡ŒæœåŠ¡å™¨éƒ¨ç½²å‘½ä»¤ï¼ˆå®‰è£…ä¾èµ–ã€å…‹éš†ä»£ç ã€å¯åŠ¨æœåŠ¡ç­‰ï¼‰
          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no \
            root@$SERVER_IP \
            "export GITHUB_PAT='$GITHUB_PAT' && \
             export GITHUB_USERNAME='$GITHUB_USERNAME' && \
             export GITHUB_REPO='$GITHUB_REPO' && \
             export DOMAIN='$DOMAIN' && \
             cd /var/www/QuoteOnline && \
             # å®‰è£…ç³»ç»Ÿä¾èµ–
             apt update -y && \
             DEPS=('git' 'curl' 'jq' 'openssl' 'docker.io' 'certbot') && \
             for dep in \"\${DEPS[@]}\"; do \
               if ! command -v \"\$dep\" &>/dev/null; then \
                 apt install -y \"\$dep\"; \
               fi; \
             done && \
             systemctl enable docker && \
             systemctl start docker && \
             # å®‰è£… Docker Compose
             if ! docker compose version &>/dev/null; then \
               mkdir -p /usr/local/lib/docker/cli-plugins && \
               curl -SL https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-linux-x86_64 \
                 -o /usr/local/lib/docker/cli-plugins/docker-compose && \
               chmod +x /usr/local/lib/docker/cli-plugins/docker-compose; \
             fi && \
             # å…‹éš†/æ›´æ–°ä»£ç ï¼ˆä½¿ç”¨ PAT è®¿é—®ç§æœ‰ä»“åº“ï¼‰
             if [ -d \"/var/www/QuoteOnline/.git\" ]; then \
               cd /var/www/QuoteOnline && git pull origin main; \
             else \
               rm -rf /var/www/QuoteOnline && \
               git clone https://\$GITHUB_USERNAME:\$GITHUB_PAT@github.com/\$GITHUB_USERNAME/\$GITHUB_REPO.git /var/www/QuoteOnline; \
             fi && \
             # é…ç½® Nginx
             TEMPLATE=\"/var/www/QuoteOnline/client/nginx.conf.template\" && \
             NGINX_CONF=\"/var/www/QuoteOnline/client/nginx.conf\" && \
             if [ ! -f \"\$TEMPLATE\" ]; then \
               echo \"æ‰¾ä¸åˆ° nginx.conf.template\"; exit 1; \
             fi && \
             sed \"s/{{DOMAIN}}/\$DOMAIN/g\" \$TEMPLATE > \$NGINX_CONF && \
             # å¯åŠ¨æœåŠ¡å¹¶é…ç½® SSL
             docker compose up -d --build && \
             docker compose stop nginx && \
             certbot certonly --standalone -d \$DOMAIN --non-interactive --agree-tos --register-unsafely-without-email && \
             # é…ç½® SSL è‡ªåŠ¨ç»­æœŸ
             (crontab -l 2>/dev/null; echo \"0 3 * * * certbot renew --quiet && docker compose -f /var/www/QuoteOnline/docker-compose.yml restart nginx\") | crontab - && \
             docker compose start nginx"

      - name: éƒ¨ç½²å®Œæˆæç¤º
        run: |
          echo "======================================"
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ"
          echo "ğŸŒ è®¿é—®åœ°å€: https://${{ github.event.inputs.domain }}"
          echo "======================================"