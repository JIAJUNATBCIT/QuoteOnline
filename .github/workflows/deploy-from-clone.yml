name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "部署域名（例如 portal.ooishipping.com）"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate .env from GitHub Environment
        shell: bash
        run: |
          set -euo pipefail

          DOMAIN="${{ github.event.inputs.domain }}"
          [[ -n "$DOMAIN" ]] || { echo "domain is empty"; exit 1; }

          cat > .env <<EOF
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://${DOMAIN}
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760

          # ===== Secrets =====
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}

          # ===== Vars =====
          EMAIL_FROM=${{ vars.EMAIL_FROM }}
          EMAIL_HOST=${{ vars.EMAIL_HOST }}
          EMAIL_PORT=${{ vars.EMAIL_PORT }}
          ENABLE_QUOTE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_QUOTE_EMAIL_NOTIFICATIONS }}
          MAILGUN_DOMAIN=${{ vars.MAILGUN_DOMAIN }}
          EOF

          # sanity checks: avoid pushing empty env accidentally
          grep -q '^MONGODB_URI=' .env || { echo "MONGODB_URI missing"; exit 1; }
          grep -q '^JWT_SECRET=' .env || { echo "JWT_SECRET missing"; exit 1; }
          grep -q '^JWT_REFRESH_SECRET=' .env || { echo "JWT_REFRESH_SECRET missing"; exit 1; }
          grep -q '^EMAIL_PASS=' .env || { echo "EMAIL_PASS missing"; exit 1; }
          grep -q '^MAILGUN_API_KEY=' .env || { echo "MAILGUN_API_KEY missing"; exit 1; }

      - name: Upload .env and apply (docker compose up + restart)
        shell: bash
        env:
          SERVER_IP: ${{ secrets.SERVER_RESERVED_IP }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          PROJECT_DIR: /var/www/QuoteOnline
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          # Upload .env
          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            .env root@"$SERVER_IP":"$PROJECT_DIR/.env"

          # Apply on server: ensure compose is running and reload env by restart
          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            root@"$SERVER_IP" "bash -lc '
              set -euo pipefail
              cd \"$PROJECT_DIR\"
              test -s .env
              chmod 600 .env

              docker compose up -d
              # 重启让容器重新加载 .env
              docker compose restart backend nginx 2>/dev/null || docker compose restart

              docker compose ps
            '"
