name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "部署域名"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Generate .env from GitHub Environment
        run: |
          cat > .env <<EOF
NODE_ENV=production
PORT=3000
FRONTEND_URL=https://${{ github.event.inputs.domain }}
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760

# ===== Secrets =====
MONGODB_URI=${{ secrets.MONGODB_URI }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
EMAIL_PASS=${{ secrets.EMAIL_PASS }}
MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}

# ===== Vars =====
EMAIL_FROM=${{ vars.EMAIL_FROM }}
EMAIL_HOST=${{ vars.EMAIL_HOST }}
EMAIL_PORT=${{ vars.EMAIL_PORT }}
ENABLE_QUOTE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_QUOTE_EMAIL_NOTIFICATIONS }}
MAILGUN_DOMAIN=${{ vars.MAILGUN_DOMAIN }}
EOF

      - name: Upload .env to server
        env:
          SERVER_IP: ${{ secrets.SERVER_RESERVED_IP }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          PROJECT_DIR: /var/www/QuoteOnline
        run: |
          sudo apt update -y
          sudo apt install -y sshpass

          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no \
            .env root@$SERVER_IP:$PROJECT_DIR/.env
