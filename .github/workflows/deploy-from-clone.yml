name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "部署域名"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate .env from GitHub Environment
        shell: bash
        run: |
          set -euo pipefail

          DOMAIN="${{ github.event.inputs.domain }}"
          if [[ -z "$DOMAIN" ]]; then
            echo "domain is empty"
            exit 1
          fi

          # 生成 .env（注意：不要缩进，否则会写入前导空格）
          cat > .env <<EOF
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://${DOMAIN}
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760

          # ===== Secrets =====
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}

          # ===== Vars =====
          EMAIL_FROM=${{ vars.EMAIL_FROM }}
          EMAIL_HOST=${{ vars.EMAIL_HOST }}
          EMAIL_PORT=${{ vars.EMAIL_PORT }}
          ENABLE_QUOTE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_QUOTE_EMAIL_NOTIFICATIONS }}
          MAILGUN_DOMAIN=${{ vars.MAILGUN_DOMAIN }}
          EOF

          # 基本校验：避免意外为空
          grep -q "^MONGODB_URI=" .env || (echo "MONGODB_URI missing" && exit 1)
          grep -q "^JWT_SECRET=" .env || (echo "JWT_SECRET missing" && exit 1)
          grep -q "^EMAIL_FROM=" .env || (echo "EMAIL_FROM missing" && exit 1)

      - name: Upload .env (atomic) and restart services
        shell: bash
        env:
          SERVER_IP: ${{ secrets.SERVER_RESERVED_IP }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          PROJECT_DIR: /var/www/QuoteOnline
        run: |
          set -euo pipefail

          if [[ -z "${SERVER_IP}" ]]; then
            echo "SERVER_IP missing (check secrets.SERVER_RESERVED_IP)"
            exit 1
          fi

          sudo apt-get update -y
          sudo apt-get install -y sshpass

          # 先上传到临时文件，再原子替换，避免半写入
          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            .env root@"$SERVER_IP":"$PROJECT_DIR/.env.tmp"

          # 在服务器端：校验 + chmod + mv 替换 + 重启
          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            root@"$SERVER_IP" bash -s <<EOF_REMOTE
            set -euo pipefail

            cd "$PROJECT_DIR"

            test -f docker-compose.yml || test -f compose.yml || { echo "compose file not found in $PROJECT_DIR"; exit 1; }
            test -f .env.tmp || { echo ".env.tmp missing"; exit 1; }

            # 原子替换 .env
            chmod 600 .env.tmp
            mv -f .env.tmp .env
            chmod 600 .env

            # 确保 docker compose 可用
            docker compose version >/dev/null 2>&1 || { echo "docker compose not available"; exit 1; }

            # 拉取镜像（如果用的是 build，这一步不会伤害；如果用 image 更有用）
            docker compose pull || true

            # 启动/更新，再重启确保加载新 env
            docker compose up -d --remove-orphans
            docker compose restart backend nginx || docker compose restart

            docker compose ps
            EOF_REMOTE
