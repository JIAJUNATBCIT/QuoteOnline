# deploy-from-clone.yml
name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "部署域名"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Generate .env from GitHub Environment
        shell: bash
        run: |
          set -euo pipefail

          DOMAIN="${{ github.event.inputs.domain }}"
          [[ -n "$DOMAIN" ]] || (echo "domain is empty" && exit 1)

          # 生成 .env 文件，EOF 顶格无缩进，避免 YAML 语法错误
          cat > .env <<EOF
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://${DOMAIN}
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760

          # ===== Secrets =====
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}

          # ===== Vars =====
          EMAIL_FROM=${{ vars.EMAIL_FROM }}
          EMAIL_HOST=${{ vars.EMAIL_HOST }}
          EMAIL_PORT=${{ vars.EMAIL_PORT }}
          ENABLE_QUOTE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_QUOTE_EMAIL_NOTIFICATIONS }}
          MAILGUN_DOMAIN=${{ vars.MAILGUN_DOMAIN }}
          EOF

          # 校验关键变量是否存在
          grep -q '^MONGODB_URI=' .env || (echo "MONGODB_URI missing" && exit 1)
          grep -q '^JWT_SECRET=' .env || (echo "JWT_SECRET missing" && exit 1)

      - name: Upload .env and restart services
        shell: bash
        env:
          SERVER_IP: ${{ secrets.SERVER_RESERVED_IP }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          PROJECT_DIR: /var/www/QuoteOnline
        run: |
          set -euo pipefail
          # 安装 sshpass
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          # 上传 .env 文件到服务器
          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            .env root@$SERVER_IP:$PROJECT_DIR/.env

          # 远程执行命令：重启服务
          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            root@$SERVER_IP "bash -lc '
              set -euo pipefail
              cd \"$PROJECT_DIR\"
              test -s .env || (echo \".env file is empty\" && exit 1)
              chmod 600 .env

              # 重启容器以加载新的 .env
              docker compose up -d
              docker compose restart backend nginx || docker compose restart'"
