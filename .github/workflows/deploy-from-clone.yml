name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      server_ip:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Generate .env
        run: |
          cat > .env <<EOF
          NODE_ENV=production
          PORT=3000
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
          EOF

      - name: Upload and deploy
        env:
          SERVER_IP: ${{ github.event.inputs.server_ip }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env docker-compose.yml \
            root@$SERVER_IP:/var/www/QuoteOnline/

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no \
            root@$SERVER_IP \
            "cd /var/www/QuoteOnline && docker compose up -d --build"
