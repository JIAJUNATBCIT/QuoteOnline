name: Deploy from Clone (Environment Secrets)

on:
  workflow_dispatch:
    inputs:
      server_ip:
        description: '生产服务器IP'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y jq openssl sshpass

      - name: Prepare sensitive data and signature
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
          SIGN_SECRET: ${{ secrets.SIGN_SECRET }}
        run: |
          # 生成 JSON 格式的敏感信息
          secrets_payload=$(jq -n -c \
            --arg MONGODB_URI "$MONGODB_URI" \
            --arg JWT_SECRET "$JWT_SECRET" \
            --arg JWT_REFRESH_SECRET "$JWT_REFRESH_SECRET" \
            --arg EMAIL_PASS "$EMAIL_PASS" \
            --arg MAILGUN_API_KEY "$MAILGUN_API_KEY" \
            '{"MONGODB_URI":$MONGODB_URI,"JWT_SECRET":$JWT_SECRET,"JWT_REFRESH_SECRET":$JWT_REFRESH_SECRET,"EMAIL_PASS":$EMAIL_PASS,"MAILGUN_API_KEY":$MAILGUN_API_KEY}')
          
          # 生成 HMAC-SHA256 签名
          signature=$(echo -n "$secrets_payload" | openssl dgst -sha256 -hmac "$SIGN_SECRET" | awk '{print $2}')
          
          # 写入环境变量传递给下一步
          echo "SECRETS_PAYLOAD=$secrets_payload" >> $GITHUB_ENV
          echo "SIGNATURE=$signature" >> $GITHUB_ENV

      - name: Upload secrets and run generate-env.sh on server
        env:
          SERVER_IP: ${{ github.event.inputs.server_ip }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          SECRETS_PAYLOAD: ${{ env.SECRETS_PAYLOAD }}
          SIGNATURE: ${{ env.SIGNATURE }}
        run: |
          # 在本地生成 deploy 脚本
          echo "#!/bin/bash
          cp /tmp/secrets_payload.json /var/www/QuoteOnline/
          cp /tmp/signature.txt /var/www/QuoteOnline/
          /var/www/QuoteOnline/generate-env.sh" > deploy.sh
          chmod +x deploy.sh

          # 上传 secrets 文件和 deploy.sh 到服务器
          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            <(echo "$SECRETS_PAYLOAD") <(echo "$SIGNATURE") deploy.sh root@$SERVER_IP:/tmp/

          # 执行 deploy.sh
          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            root@$SERVER_IP "bash /tmp/deploy.sh"
