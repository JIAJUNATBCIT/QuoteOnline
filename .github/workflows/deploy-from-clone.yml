name: Deploy from Clone

on:
  workflow_dispatch:
    inputs:
      domain:
        required: true
        type: string
      github_pat:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # 关联 GitHub 环境（secrets/vars 所在环境）

    steps:
      - name: 生成完整的 .env 文件（敏感+非敏感信息）
        run: |
          cat > .env <<EOF
          # 基础配置
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://${{ github.event.inputs.domain }}
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760

          # 敏感信息（从 GitHub Environment Secrets 读取）
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}

          # 非敏感信息（从 GitHub Environment Variables 读取）
          EMAIL_FROM=${{ vars.EMAIL_FROM }}
          EMAIL_HOST=${{ vars.EMAIL_HOST }}
          EMAIL_PORT=${{ vars.EMAIL_PORT }}
          ENABLE_QUOTE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_QUOTE_EMAIL_NOTIFICATIONS }}
          MAILGUN_DOMAIN=${{ vars.MAILGUN_DOMAIN }}
          EOF

      - name: 上传完整的 .env 到服务器
        env:
          SERVER_IP: ${{ secrets.SERVER_RESERVED_IP }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          PROJECT_DIR: "/var/www/QuoteOnline"
        run: |
          # 安装 sshpass（用于密码登录）
          apt update -y && apt install -y sshpass

          # 上传 .env 到服务器项目目录（覆盖原有文件）
          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env root@$SERVER_IP:$PROJECT_DIR/

          # 执行服务器端的后续操作（如重启服务）
          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no root@$SERVER_IP \
            "cd $PROJECT_DIR && docker compose restart"